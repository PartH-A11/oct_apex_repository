pipeline {
    agent any

    environment {
        APEX_WORKSPACE = "edc_jcdc_dev"
        APEX_USERNAME = "parth.suthar"
        DB_HOST = "13.203.90.85"
        DB_SERVICE = "osprod.OSPROD"
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'test', url: 'https://github.com/PartH-A11/oct_apex_repository'
                fingerprint 'f987456321_v20250324_122639.sql'
            }
        }

        stage('Retrieve Credentials') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(credentialsId: 'DBpassword', usernameVariable: 'DB_USER', passwordVariable: 'DB_PASSWORD')
                    ]) {
                        env.DB_CONN = "${DB_USER}/${DB_PASSWORD}@${DB_HOST}:1521/${DB_SERVICE}"
                    }
                }
            }
        }

        stage('Validate SQL Files') {
            steps {
                script {
                    def sqlFile = "App_Code/f987456321_v20250324_122639.sql"
                    sh "sed -i 's/2987456321/99987456321/g' ${sqlFile}"
                    sh "sed -i 's/SUN_22001_DEV/SUN_22001_TEST/g' ${sqlFile}"
                    sh "sed -i 's/sun_22001_dev/sun_22001_test/g' ${sqlFile}"
                    sh "sed -i 's/1096018791012195213/1096019815202199712/g' ${sqlFile}"
                    def sqlclPath = "/u01/sqlcl/sqlcl/bin/sql"
                    def result = sh(script: "\"${sqlclPath}\" -s \"${DB_CONN}\" @${sqlFile}", returnStatus: true)
                    if (result != 0) {
                        error "SQL validation failed! Check script for errors."
                    }
                }
            }
        }

        stage('Deploy APEX Application') {
            steps {
                script {
                    def files = findFiles(glob: 'App_Code/f987456321_v20250324_122639.sql')
                    files.each { file ->
                        echo "Deploying SQL file: ${file.name}"
                        sh "/u01/sqlcl/sqlcl/bin/sql -s \"${DB_CONN}\" @${file.path}"
                    }
                }
            }
        }
        
stage('Update and Push to Test Branch') {
    steps {
        script {
            def originalFile = "App_Code/f987456321_v20250324_122639.sql"

            // Generate versioned filename
            def version = new Date().format("yyyyMMdd_HHmmss")
            def versionedFile = "App_Code/f987456321_v20250324_122639_v${version}.sql"

            // Copy and modify the versioned file (leave original untouched)
            sh "cp ${originalFile} ${versionedFile}"
            sh "sed -i 's/2987456321/99987456321/g' ${versionedFile}"
            sh "sed -i 's/SUN_22001_TEST/SUN_22001_TEST1/g' ${versionedFile}"
            sh "sed -i 's/sun_22001_test/sun_22001_test1/g' ${versionedFile}"
            sh "sed -i 's/1096018791012195213/1096019815202199712/g' ${versionedFile}"

            // Use credentials to push
            withCredentials([usernamePassword(credentialsId: 'GITHUB_CREDS', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                sh 'git config user.name "PartH-A11"'
                sh 'git config user.email "parth.suthar@octalsoft.com"'

                // Reset changes before switching branch
                sh "git restore ${originalFile}"
                sh 'git checkout live'
                sh 'git pull origin live'
                sh 'git remote set-url origin https://${GIT_USER}:${GIT_TOKEN}@github.com/PartH-A11/oct_apex_repository.git'

                // Add and push versioned file
                sh "git add ${versionedFile}"
                sh "git commit -m 'Added versioned SQL: ${versionedFile}' || echo 'No changes to commit'"
                sh 'git push origin live'
            }
        }
    }
}




        stage('Notify') {
            steps {
                echo "Deployment successful! APEX Application is live on: https://bkp2.octalsoft.com/apex/r/apex/workspace-sign-in"
            }
        }
    }
}
