pipeline {
    agent any

    environment {
        APEX_WORKSPACE = "edc_jcdc_dev"
        APEX_USERNAME = "parth.suthar"
        DB_HOST = "13.203.90.85"
        DB_SERVICE = "OSPROD"
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/PartH-A11/oct_apex_repository'
                
                // Fingerprint SQL files after checkout
                fingerprint 'f100401.sql'
            }
        }
        
        stage('Retrieve Credentials') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(credentialsId: 'DBpassword', usernameVariable: 'DB_USER', passwordVariable: 'DB_PASSWORD')
                    ]) {
                        env.DB_CONN = "${DB_USER}/${DB_PASSWORD}@//${DB_HOST}:1521/${DB_SERVICE}"
                    }
                }
            }
        }

        stage('Validate SQL Files') {
    steps {
        script {
            def sqlclPath = "D:\MILAN_DATA\sqlcl-24.4.3.070.2106\sqlcl\bin"  // Update with actual path
            def result = bat(script: "${sqlclPath} -s \"${DB_CONN}\" @validate.sql", returnStatus: true)
            if (result != 0) {
                error "SQL validation failed! Check script for errors."
            }
        }
    }
}


        stage('Deploy APEX Application') {
    steps {
        script {
            def sqlFiles = findFiles(glob: 'App_Code/*.sql')
            sqlFiles.each { file ->
                echo "Deploying SQL file: ${file.name}"
                bat "sqlcl -s \"${DB_CONN}\" @App_Code/f100401.sql"
            }
        }
    }
}

        stage('Restart ORDS') {
            steps {
                bat 'net stop ords && net start ords'
            }
        }

        stage('Notify') {
            steps {
                echo "Deployment successful! APEX Application is live on: https://bkp2.octalsoft.com/apex/r/apex/workspace-sign-in"
            }
        }
    }
}