pipeline {
    agent any

    environment {
        APEX_WORKSPACE = "TEST"
        APEX_USERNAME = "parth.suthar"
        DB_HOST = "13.203.90.85"
        DB_SERVICE = "osprod.OSPROD"
        SQLCL_PATH = "/u01/sqlcl/sqlcl/bin/sql"
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'develop', url: 'https://github.com/PartH-A11/oct_apex_repository'
            }
        }

        stage('Retrieve Credentials') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(credentialsId: 'dbpasschange', usernameVariable: 'DB_USER', passwordVariable: 'DB_PASSWORD')
                    ]) {
                        env.DB_CONN = "${DB_USER}/${DB_PASSWORD}@${DB_HOST}:1521/${DB_SERVICE}"
                    }
                }
            }
        }

        stage('Validate Database Constraints') {
            steps {
                script {
                    def constraintCheck = sh(
                        script: """
                        echo "SELECT COUNT(*) FROM APEX_240100.WWV_FLOW WHERE ID = 10008181;" | ${SQLCL_PATH} -s "${DB_CONN}"
                        """,
                        returnStdout: true
                    ).trim()

                    if (constraintCheck == "0") {
                        error "ERROR: APEX Application ID 10008181 does not exist in WWV_FLOW. Fix dependencies before deployment."
                    }
                }
            }
        }

        stage('Modify SQL Files') {
            steps {
                script {
                    def sqlFile = "App_Code/f10008181.sql"

                    // Ensure correct APEX Application ID before replacing
                    sh "sed -i 's/APEX_PIPELINE_DEV/APEX_PIPELINE_LIVE/g' ${sqlFile}"
                    sh "sed -i 's/apex_pipeline_dev/apex_pipeline_live/g' ${sqlFile}"
                }
            }
        }

        stage('Deploy APEX Application') {
            steps {
                script {
                    def sqlFile = "App_Code/f10008181.sql"
                    
                    try {
                        def deployResult = sh(
                            script: """
                            ${SQLCL_PATH} -s "${DB_CONN}" @${sqlFile}
                            """,
                            returnStatus: true
                        )

                        if (deployResult != 0) {
                            error "Deployment failed! Check SQL script for errors."
                        }
                    } catch (Exception e) {
                        error "SQL Deployment Error: ${e.getMessage()}"
                    }
                }
            }
        }

        stage('Update and Push to live Branch') {
            steps {
                script {
                    def originalFile = "App_Code/f10008181.sql"
                    def version = new Date().format("yyyyMMdd_HHmmss")
                    def versionedFile = "App_Code/f10008181_${version}.sql"

                    // Backup SQL file
                    sh "cp ${originalFile} ${versionedFile}"

                    withCredentials([usernamePassword(credentialsId: 'GITHUB_CREDS', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                        sh 'git config user.name "PartH-A11"'
                        sh 'git config user.email "parth.suthar@octalsoft.com"'
                        sh 'git checkout live'
                        sh 'git pull origin live'
                        sh "git add ${versionedFile}"
                        sh "git commit -m 'Added versioned SQL: ${versionedFile}' || echo 'No changes to commit'"
                        sh 'git push origin live'
                    }
                }
            }
        }

        stage('Notify') {
            steps {
                echo "Deployment successful! APEX Application is live on: https://ins5.octalsoft.com/apex/r/apex/workspace-sign-in"
            }
        }
    }
}
